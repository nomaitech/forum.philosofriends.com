{% extends "base.html" %}

{% block title %}{{ question.title }} · Philosofriends{% endblock %}

{% block meta %}
    {% if question.body %}
        <meta name="description" content="{{ question.body|striptags|truncatewords:24 }}">
    {% else %}
        <meta name="description" content="{{ question.title|striptags }}">
    {% endif %}
    <meta property="og:type" content="article">
    <meta property="og:title" content="{{ question.title|striptags }}">
    <meta property="og:description" content="{% if question.body %}{{ question.body|striptags|truncatewords:24 }}{% else %}{{ question.title|striptags }}{% endif %}">
    <meta property="og:url" content="{{ request.build_absolute_uri }}">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="{{ question.title|striptags }}">
    <meta name="twitter:description" content="{% if question.body %}{{ question.body|striptags|truncatewords:24 }}{% else %}{{ question.title|striptags }}{% endif %}">
{% endblock %}

{% block content %}
    <article class="hn-article">
        <h1>{{ question.title }}</h1>
        <div class="hn-item-meta">
            asked by {{ question.author.username }} · {{ question.created_at|date:"M j, Y" }}
        </div>
        {% if question.link %}
            <p class="hn-body">
                <a href="{{ question.link }}" rel="noopener noreferrer" target="_blank">{{ question.link }}</a>
            </p>
        {% endif %}
        {% if question.body %}
            <p class="hn-body">{{ question.body|linebreaksbr }}</p>
        {% else %}
            <p class="hn-body hn-muted">No additional context.</p>
        {% endif %}
    </article>

    <section class="hn-comments">
        <h2>Comments</h2>
        {% if comments %}
            <ul class="hn-comment-list">
                {% for comment in comments %}
                    {% include "questions/_comment.html" with comment=comment %}
                {% endfor %}
            </ul>
        {% else %}
            <p class="hn-body hn-muted">No comments yet.</p>
        {% endif %}

        {% if user.is_authenticated %}
            <form class="hn-form hn-comment-form" id="comment-form" method="post">
                {% csrf_token %}
                <input type="hidden" name="parent_id" id="comment-parent-id" value="{{ reply_parent_id|default:'' }}">
                <div class="hn-replying" id="replying-to"{% if not reply_parent_id %} hidden{% endif %}>
                    Replying to <span id="replying-to-name">{{ reply_parent_author|default:'' }}</span>
                    <button class="hn-reply-cancel" type="button" id="reply-cancel">Cancel</button>
                </div>
                <div class="hn-field">
                    {{ comment_form.body }}
                    {% if comment_form.body.errors %}
                        <div class="hn-error">{{ comment_form.body.errors }}</div>
                    {% endif %}
                </div>
                <button class="hn-button" type="submit">Post comment</button>
            </form>
        {% else %}
            <p class="hn-body hn-muted">
                <a href="/accounts/login/?next=/questions/{{ question.slug }}/">Log in</a> to post a comment.
            </p>
        {% endif %}
    </section>

    {% if user.is_authenticated %}
        <script>
            (() => {
                const replyButtons = document.querySelectorAll('.hn-reply-button');
                const parentInput = document.getElementById('comment-parent-id');
                const replyingTo = document.getElementById('replying-to');
                const replyingName = document.getElementById('replying-to-name');
                const replyCancel = document.getElementById('reply-cancel');
                const commentBody = document.getElementById('id_body');
                const commentForm = document.getElementById('comment-form');

                const clearReply = () => {
                    if (parentInput) parentInput.value = '';
                    if (replyingName) replyingName.textContent = '';
                    if (replyingTo) replyingTo.hidden = true;
                };

                replyButtons.forEach((button) => {
                    button.addEventListener('click', () => {
                        const commentId = button.getAttribute('data-comment-id');
                        const author = button.getAttribute('data-comment-author');
                        if (parentInput) parentInput.value = commentId;
                        if (replyingName) replyingName.textContent = author || 'this comment';
                        if (replyingTo) replyingTo.hidden = false;
                        if (commentBody) commentBody.focus();
                        if (commentForm) commentForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    });
                });

                if (replyCancel) {
                    replyCancel.addEventListener('click', clearReply);
                }
            })();
        </script>
    {% endif %}
{% endblock %}
